# Test code for the NAE modules
# Copyright: (c) 2020, Cindy Zhao (cizhao) <cizhao@cisco.com>

# GNU General Public License v3.0+ (see LICENSE or https://www.gnu.org/licenses/gpl-3.0.txt)

- name: Test that we have an NAE host, NAE username and NAE password
  fail:
    msg: 'Please define the following variables: nae_host, nae_username and nae_password.'
  when: nae_host is not defined or nae_username is not defined or nae_password is not defined

- name: Set vars
  set_fact: 
    nae_info: &nae_info
      host: '{{ nae_host }}'
      username: '{{ nae_username }}'
      password: '{{ nae_password }}'
      validate_certs: '{{ nae_validate_certs | default(false) }}'

- name: Create an object selector
  nae_compliance:
    <<: *nae_info
    state: present
    selector: object
    form: |
        {
        "name": "ansible_object_selector",
        "description": null,
        "includes": [
            {
            "matches": [
                {
                "application_epgmatch": {
                    "object_attribute": "DN",
                    "tenant": {
                    "pattern": "NAE_Compliance",
                    "type": "EXACT"
                    },
                    "application_profile": {
                    "pattern": "ComplianceIsGood",
                    "type": "EXACT"
                    },
                    "application_epg": {
                    "pattern": "DataBase",
                    "type": "EXACT"
                    }
                }
                }
            ]
            }
        ],
        "excludes": [],
        "selector_type": "OST_EPG"
        }

- name: Create a compliance requirement
  nae_compliance:
    <<: *nae_info
    state: present
    selector: requirement
    form: |
    {
        "name": "ansible_comp_requirement",
        "config_compliance_parameter": {
        },
        "epg_selector_a": "FrontEnd",
        "epg_selector_b": "DataBase",
        "requirement_type": "SEGMENTATION",
        "communication_type": "MUST_NOT",
        "is_all_traffic": false
    }

- name: Create a compliance requirement set
  nae_compliance:
    <<: *nae_info
    state: present
    selector: requirement_set
    ag_name: FAB2
    form: |
    {
        "name": "ansible_comp_requirement_set",
        "requirements": [
            "Segmentation"
        ]
    }